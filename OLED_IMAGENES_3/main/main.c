/************************************************************************************************
 * Programa: Pruebas de desarrollo para el control de display OLED con imagenes
 * 
 * Descripción: Programa diseñado para la configuración de una display OLED SSD1306, mediante la 
 * configuración de un sistema de comunicación I2C, en donde se establecen los pines GPIO22 y GPIO21
 * como SCL Y SDA respectivamente, se define en una matriz llamada image_data una imagen que se 
 * muestra durante 5 segundos en la OLED mediante diferente funciones que ofrece la libreria SSD1306, 
 * posteriorment la pantalla es limpiada para poder realizar la escritura de 2 palabras ("HOLA", "MUNDO")
 *  en esta mediante el arreglo data_str con funciones de la libreria SSD1306.
 *
 * Director: 
 *   - David Ricardo Rivera Albeladez
 * 
 * Co-director:
 *   - Victor Manuel Patiño Delgado
 * 
 * Autores:
 *   - Mariana Rivera Garcia
 *   - Juliana Muriel Barreto
 * 
 * Fecha de desarrollo: Septiembre de 2023
 * 
 * Licencia: THE BEER-WARE LICENSE
 * As long as you retain this notice you can do whatever you want with this stuff. 
 * If we meet some day, and you think this stuff is worth it, you can buy me a beer in return.
************************************************************************************************/

/* Bibliotecas y declaraciones de preprocesador */
#include <stdio.h>                  //Incluye la biblioteca estandar de entrada y salida
#include <stdlib.h>                 //Incluye la biblioteca para la gestión de memoria dinámica
#include "freertos/FreeRTOS.h"      // Incluye la biblioteca FreeRTOS para programación multitarea en tiempo real
#include "freertos/task.h"          // Incluye la biblioteca FreeRTOS para la administración de tareas
#include "ssd1306.h"                //Incluye la biblioteca que permite acceso a funciones del dispositivo SSD1306

/* Definición de constantes y macros */
#define I2C_MASTER_SCL_IO 22        //Define el pin GPIO22 I2C como SCL
#define I2C_MASTER_SDA_IO 21        //Define el pin GPIO21 I2C como SDA
#define I2C_MASTER_NUM I2C_NUM_1    //Define el número de puerto I2C para el desarrollador maestro
#define I2C_MASTER_FREQ_HZ 100000   //Define la frecuebcia del reloj del maestro I2C

//Declara variable estatica ssd1306_dev de tipo ssd1306_handle_t incicializada en NULL
static ssd1306_handle_t ssd1306_dev = NULL;


// Función principal (main) 
void app_main(void)
{
    //Configuración de la comunicación I2C/
    i2c_config_t conf;
    //Define comunicación en modo maestro
    conf.mode = I2C_MODE_MASTER;
    //Define el pin SDA
    conf.sda_io_num = (gpio_num_t)I2C_MASTER_SDA_IO;
    //Habilita resistencia pull up del pin SDA
    conf.sda_pullup_en = GPIO_PULLUP_ENABLE;
    //Define el pin SCL
    conf.scl_io_num = (gpio_num_t)I2C_MASTER_SCL_IO;
    //Habilita resistencia pull up del pin SCL
    conf.scl_pullup_en = GPIO_PULLUP_ENABLE;
    //Define la frecuencia del reloj del maestro
    conf.master.clk_speed = I2C_MASTER_FREQ_HZ;
    //Establece  la señal de reloj (SCL) para I2C como normal
    conf.clk_flags = I2C_SCLK_SRC_FLAG_FOR_NOMAL;
    //Configura parametros del bus I2C
    i2c_param_config(I2C_MASTER_NUM, &conf);
    //Instala y configura el controlador del bus I2C
    i2c_driver_install(I2C_MASTER_NUM,conf.mode, 0, 0, 0);
    
    /*Configuración del dispositivo SSD1306 */
    //Crea instancia del dispositivo SSD1306 que se comunicará a través del bus I2C configurado
    ssd1306_dev = ssd1306_create(I2C_MASTER_NUM, SSD1306_I2C_ADDRESS);
    //Actualiza físicamente los píxeles en la pantalla OLED con la información almacenada en la memoria GRAM
    ssd1306_refresh_gram(ssd1306_dev);
    //Establece todos los pixeles de la OLED en negro, borra la pantalla
    ssd1306_clear_screen(ssd1306_dev, 0x00);

    //definición de matriz con los bytes de la OLED
    const uint8_t image_data[] = {
        // Se definen los bytes de la imagen en formato monocrómico
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x03, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x03, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x03, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x07, 0xbe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x3f, 0xbf, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x7c, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x06, 0x00, 0xe0, 0x0c, 0x03, 0x34, 0x5a, 0x2f, 0xbe, 0x72, 0x78, 0xc7, 0xc0, 
        0x00, 0x00, 0x00, 0x0e, 0x03, 0xfc, 0x0e, 0x03, 0x36, 0x5b, 0x2c, 0x36, 0xc2, 0x4c, 0xe6, 0x40, 
        0x00, 0x00, 0x00, 0x0c, 0x07, 0xfe, 0x06, 0x03, 0x37, 0x59, 0x6f, 0xbe, 0xf2, 0x4c, 0xa4, 0x60, 
        0x00, 0x00, 0x00, 0x0c, 0x0f, 0xfe, 0x06, 0x03, 0x35, 0xd9, 0xcc, 0x3c, 0x3a, 0x4d, 0xf4, 0x60, 
        0x00, 0x00, 0x00, 0x1c, 0x0f, 0xff, 0x07, 0x81, 0x64, 0xd8, 0xcc, 0x34, 0xda, 0x59, 0x36, 0xc0, 
        0x00, 0x00, 0x00, 0x3c, 0x1f, 0xff, 0x03, 0x81, 0xe4, 0x48, 0x8f, 0xb2, 0x72, 0x73, 0x17, 0x80, 
        0x00, 0x00, 0x00, 0x60, 0x1f, 0xff, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0xe0, 0x1f, 0xff, 0x00, 0xe0, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0xe0, 0x0f, 0xff, 0x00, 0xe0, 0xc8, 0xbc, 0xe6, 0x0f, 0x22, 0x30, 0xf3, 0xc0, 
        0x00, 0x00, 0x00, 0xe0, 0x0f, 0xfe, 0x00, 0xe0, 0xcc, 0xbd, 0xb6, 0x7d, 0xb7, 0x30, 0xfb, 0x00, 
        0x00, 0x00, 0x01, 0xe0, 0x07, 0xfe, 0x00, 0xf0, 0xec, 0x99, 0x1f, 0x78, 0xbf, 0x78, 0xcf, 0xc0, 
        0x00, 0x00, 0x01, 0xe0, 0x07, 0xfc, 0x00, 0x71, 0xec, 0x9b, 0x1d, 0xf8, 0xbf, 0x78, 0xcf, 0xc0, 
        0x00, 0x00, 0x00, 0x80, 0x01, 0xf8, 0x00, 0x71, 0xfc, 0x99, 0x1c, 0xf9, 0xa3, 0x7c, 0xca, 0x00, 
        0x00, 0x00, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x62, 0x37, 0x98, 0xf4, 0x6f, 0x23, 0x8c, 0xf3, 0xe0, 
        0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x60, 0x00, 0x04, 0x02, 0x20, 0xbc, 0x40, 0x39, 0xc0, 
        0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x60, 0x00, 0x06, 0x66, 0x36, 0xbc, 0xe4, 0x7b, 0xc0, 
        0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x60, 0x00, 0x07, 0xef, 0x36, 0x88, 0xe4, 0x63, 0x00, 
        0x00, 0x00, 0x00, 0x60, 0x00, 0x40, 0x00, 0x60, 0x00, 0x07, 0xaf, 0x3e, 0x98, 0xb4, 0x79, 0xc0, 
        0x00, 0x00, 0x00, 0x60, 0x03, 0xf8, 0x00, 0x60, 0x00, 0x05, 0x2f, 0xae, 0xb1, 0xf4, 0x60, 0x60, 
        0x00, 0x00, 0x00, 0x60, 0x0e, 0x1e, 0x00, 0x60, 0x00, 0x04, 0x38, 0xa6, 0xbf, 0x1f, 0xff, 0xe0, 
        0x00, 0x00, 0x00, 0x60, 0x38, 0x03, 0x80, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x60, 0x67, 0xfc, 0xc0, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x60, 0x6f, 0xfe, 0xc0, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x60, 0x6f, 0xfe, 0xc0, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x60, 0x6f, 0xfe, 0xc0, 0x60, 0x00, 0x00, 0x06, 0x06, 0x0c, 0x06, 0x00, 0xc0, 
        0x00, 0x00, 0x00, 0x60, 0x6f, 0xfe, 0xc0, 0x60, 0x00, 0x00, 0x0e, 0x0e, 0x1e, 0x07, 0x01, 0xec, 
        0x00, 0x00, 0x00, 0x60, 0x6f, 0xfe, 0xc0, 0x60, 0x00, 0x00, 0x0e, 0x0e, 0x1f, 0x07, 0x81, 0xec, 
        0x00, 0x00, 0x00, 0x60, 0x6f, 0xfe, 0xc0, 0x60, 0x00, 0x00, 0x0e, 0x0e, 0x1f, 0x07, 0x83, 0xe0, 
        0x00, 0x00, 0x00, 0x60, 0x6f, 0xfe, 0xc0, 0x60, 0x00, 0x00, 0x0e, 0x0e, 0x3f, 0x87, 0xc3, 0xe0, 
        0x00, 0x00, 0x03, 0xc2, 0xef, 0xfe, 0xec, 0x78, 0x00, 0x00, 0x0e, 0x0e, 0x3b, 0x87, 0xc7, 0xe0, 
        0x00, 0x00, 0x07, 0xff, 0xcf, 0xfe, 0x3f, 0xfc, 0x00, 0x00, 0x0e, 0x0e, 0x73, 0xc7, 0xef, 0xe0, 
        0x00, 0x00, 0x06, 0x78, 0x0f, 0xfe, 0x03, 0xcc, 0x00, 0x00, 0x0e, 0x0e, 0x71, 0xc7, 0xfe, 0xe0, 
        0x00, 0x00, 0x1e, 0x00, 0x0f, 0xfe, 0x00, 0x4f, 0x00, 0x00, 0x0e, 0x0e, 0xff, 0xe7, 0x7c, 0xe0, 
        0x00, 0x00, 0x3e, 0x00, 0x0f, 0xfe, 0x00, 0x0f, 0x80, 0x00, 0x0f, 0x0e, 0xff, 0xe7, 0x3c, 0xe0, 
        0x00, 0x00, 0x30, 0x00, 0x1f, 0xff, 0x00, 0x00, 0xc0, 0x00, 0x0f, 0xff, 0xe0, 0xe7, 0x38, 0xe0, 
        0x00, 0x00, 0x60, 0x0f, 0xff, 0xff, 0xfe, 0x00, 0xc0, 0x00, 0x07, 0xfd, 0xc0, 0x7f, 0x10, 0xe0, 
        0x00, 0x00, 0x60, 0xfe, 0x00, 0x00, 0x0f, 0xe0, 0xc0, 0x00, 0x03, 0xfb, 0xc0, 0x7f, 0x00, 0xe0, 
        0x00, 0x00, 0xef, 0xc0, 0x1f, 0xff, 0x00, 0x7f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x03, 0xfc, 0x0f, 0xff, 0xff, 0xfe, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x07, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xf0, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x0f, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xe0, 
        0x00, 0x38, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe3, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0xe3, 0xff, 0xfe, 0x00, 0x00, 0x0f, 0xff, 0xf8, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x03, 0x8f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x3f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x03, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    
    //Función que permite dibujar la image_data creada en la OLED
    ssd1306_draw_bitmap(ssd1306_dev, 0, 0, image_data, 128, 64);
    //Actualizar y refrescar la memoria de graficos de la OLED
    ssd1306_refresh_gram(ssd1306_dev);
    //Se detiene la ejecución de la tarea por un tiempo
    vTaskDelay(pdMS_TO_TICKS(5000));
    
    //Se limpia el contenido de la pantalla OLED
    ssd1306_clear_screen(ssd1306_dev, 0x00);
    
    //Crea arreglo de 10 caracteres inicializado en cero
    char data_str[10] = {0};
    //Escribe en el arreglo la palabra "HOLA"
    sprintf(data_str, "HOLA");
    //Función que permite dibujar el contenigo del arreglo en la OLED
    ssd1306_draw_string(ssd1306_dev, 20, 10, (const uint8_t *)data_str, 16, 1);
    //Escribe en el arreglo la palabra "MUNDO"
    sprintf(data_str, "MUNDO");
    //Función que permite dibujar el contenigo del arreglo en la OLED
    ssd1306_draw_string(ssd1306_dev, 20, 30, (const uint8_t *)data_str, 16, 1);
    //Actualizar y refrescar la memoria de graficos de la OLED
    ssd1306_refresh_gram(ssd1306_dev);
}
